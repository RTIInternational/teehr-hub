apiVersion: v1
kind: ServiceAccount
metadata:
  name: iceberg-rest
  namespace: teehr-hub
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::935462133478:role/teehr-hub-iceberg-s3-warehouse-irsa
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: iceberg-rest-catalog-pvc
  namespace: teehr-hub
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---    
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: iceberg-rest
  name: iceberg-rest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: iceberg-rest
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: iceberg-rest
    spec:
      serviceAccountName: iceberg-rest
      securityContext:
        fsGroup: 1000
      # Fix permissions on the mounted volume
      initContainers:
      - name: fix-permissions
        image: alpine:3.18
        command: 
        - sh
        - -c
        - |
          chown -R 1000:1000 /data
          chmod -R 755 /data
        volumeMounts:
        - name: catalog-storage
          mountPath: /data
        securityContext:
          runAsUser: 0
      containers:
      - image: tabulario/iceberg-rest
        imagePullPolicy: IfNotPresent
        name: iceberg-rest
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
        env:
        ${if environment.name == "local"}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: minio-secrets
              key: accesskey
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-secrets
              key: secretkey
        - name: CATALOG_S3_ENDPOINT
          value: ${var.iceberg.catalogS3Endpoint}
        - name: CATALOG_S3_PATH__STYLE__ACCESS
          value: "${var.iceberg.catalogS3PathStyleAccess}"
        ${endif}
        - name: AWS_REGION
          value: us-east-2
        - name: CATALOG_WAREHOUSE
          value: ${var.iceberg.catalogWarehouse}
        - name: CATALOG_IO__IMPL
          value: org.apache.iceberg.aws.s3.S3FileIO
        - name: CATALOG_CATALOG__IMPL
          value: org.apache.iceberg.jdbc.JdbcCatalog
        - name: CATALOG_URI
          value: jdbc:sqlite:/data/iceberg_catalog.db
        - name: CATALOG_JDBC_USER
          value: iceberg
        - name: CATALOG_JDBC_PASSWORD
          value: iceberg
        ports:
        - name: http
          containerPort: 8181
          protocol: TCP
        volumeMounts:
        - name: catalog-storage
          mountPath: /data
        # livenessProbe:
        #   httpGet:
        #     path: /healthz
        #     port: http
        # readinessProbe:
        #   httpGet:
        #     path: /healthz
        #     port: http
        resources: {}
      volumes:
      - name: catalog-storage
        persistentVolumeClaim:
          claimName: iceberg-rest-catalog-pvc

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: iceberg-rest
  name: iceberg-rest
spec:
  ports:
  - protocol: TCP
    port: 8181
    targetPort: 8181
  selector:
    app: iceberg-rest
  type: ClusterIP