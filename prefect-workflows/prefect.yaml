# Welcome to your prefect.yaml file! You can you this file for storing and managing
# configuration for deploying your flows. We recommend committing this file to source
# control along with your flow code.

# Generic metadata about this project
name: teehr-hub
prefect-version: 3.4.24

# build section allows you to manage and build docker images
build: null

# push section allows you to manage if and how this project is uploaded to remote locations
push: null

# pull section allows you to provide instructions for cloning this project in remote locations
pull: null

# the definitions section allows you to define reusable components for your deployments
definitions:
  log_level: &log_level INFO
  tags: &common_tags
    - k8s
  kind_work_pool: &kind_work_pool
    name: kubernetes-pool
    job_variables:
      image: "{{ $PREFECT_TEEHR_IMAGE }}"
      image_pull_policy: Always
      namespace: "{{ $TEEHR_NAMESPACE }}"
      finished_job_ttl: 300
      pod_watch_timeout_seconds: 300
      env:
        PREFECT_LOGGING_LEVEL: *log_level
        TEEHR_SPARK_IMAGE: "{{ $TEEHR_SPARK_IMAGE }}"
        TEEHR_NAMESPACE: "{{ $TEEHR_NAMESPACE }}"
        # Temporary AWS creds for Spark access to S3/MinIO in dev
        # Ultimately, we should use K8s secrets or IRSA for this.
        AWS_REGION: "{{ $AWS_REGION }}"
        AWS_ACCESS_KEY_ID: "{{ $AWS_ACCESS_KEY_ID }}"
        AWS_SECRET_ACCESS_KEY: "{{ $AWS_SECRET_ACCESS_KEY }}"
        CATALOG_REST_URI: "{{ $CATALOG_REST_URI }}"
        REMOTE_CATALOG_TYPE: "{{ $REMOTE_CATALOG_TYPE }}"
        WAREHOUSE_S3_PATH: "{{ $WAREHOUSE_S3_PATH }}"
      node_selector:
        teehr-hub/nodegroup-name: spark-r5-4xlarge
      tolerations:
        - key: teehr-hub/dedicated
          operator: Equal
          value: worker
          effect: NoSchedule
        - key: teehr-hub_dedicated
          operator: Equal
          value: worker
          effect: NoSchedule
 
# the deployments section allows you to provide configuration for deploying flows
deployments:
  # Workflows that are configured for local KIND cluster
  - name: kind-echo-text
    version:
    tags: []
    description: Simple test flow.
    entrypoint: workflows/example_workflow.py:hello
    parameters: {}
    work_pool: *kind_work_pool
    schedule:
  - name: kind-create-spark-session
    version:
    tags: []
    description: Create TEEHR spark session
    entrypoint: workflows/teehr_prefect_spark.py:create
    parameters: {}
    work_pool: *kind_work_pool
    schedule:
  - name: kind-list-data-drive
    version:
    tags: []
    description: Create TEEHR spark session
    entrypoint: workflows/check_data_drive.py:list
    parameters: {}
    work_pool: *kind_work_pool
    schedule:
  - name: kind-test-iceberg
    version:
    tags: []
    description: Create TEEHR spark session
    entrypoint: workflows/teehr_iceberg_spark.py:check
    parameters: {}
    work_pool: *kind_work_pool
    schedule: